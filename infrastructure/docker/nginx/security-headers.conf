# Security Headers Configuration for KGV Migration
# Include this file in server blocks for comprehensive security headers

# Prevent clickjacking attacks
add_header X-Frame-Options "DENY" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Enable XSS protection (legacy browsers)
add_header X-XSS-Protection "0" always;

# Referrer policy for privacy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (formerly Feature Policy)
add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()" always;

# Cross-Origin policies
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Strict Transport Security (HSTS) - Only for HTTPS
# add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# Content Security Policy - Strict by default
# This should be customized based on application needs
set $csp_default "default-src 'self'";
set $csp_script "script-src 'self'";
set $csp_style "style-src 'self'";
set $csp_img "img-src 'self' data: https:";
set $csp_font "font-src 'self' data:";
set $csp_connect "connect-src 'self'";
set $csp_media "media-src 'self'";
set $csp_object "object-src 'none'";
set $csp_frame_anc "frame-ancestors 'none'";
set $csp_base "base-uri 'self'";
set $csp_form "form-action 'self'";
set $csp_upgrade "upgrade-insecure-requests";

# Combine CSP directives
set $csp "${csp_default}; ${csp_script}; ${csp_style}; ${csp_img}; ${csp_font}; ${csp_connect}; ${csp_media}; ${csp_object}; ${csp_frame_anc}; ${csp_base}; ${csp_form}";

# Apply CSP header
add_header Content-Security-Policy $csp always;

# Report-only CSP for testing (uncomment to test before enforcing)
# add_header Content-Security-Policy-Report-Only $csp always;

# Additional security headers for production
add_header X-Permitted-Cross-Domain-Policies "none" always;
add_header X-Download-Options "noopen" always;
add_header X-DNS-Prefetch-Control "off" always;

# Cache control for security
add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
add_header Pragma "no-cache" always;
add_header Expires "0" always;

# Remove unnecessary headers
more_clear_headers Server;
more_clear_headers X-Powered-By;
more_clear_headers X-AspNet-Version;
more_clear_headers X-AspNetMvc-Version;