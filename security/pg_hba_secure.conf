# PostgreSQL Host-Based Authentication Configuration
# Secure configuration for KGV Migration - GDPR Compliant
# Version: PostgreSQL 16
# Last Updated: 2025-08-04

# ==============================================================================
# SECURITY NOTICE
# ==============================================================================
# This configuration enforces:
# 1. SSL/TLS for all remote connections (GDPR Article 32)
# 2. SCRAM-SHA-256 authentication (no plain text passwords)
# 3. Strict IP-based access control
# 4. Separate authentication for different user classes
# 5. Audit logging for all connection attempts

# ==============================================================================
# CONNECTION TYPE REFERENCE
# ==============================================================================
# TYPE     DATABASE        USER            ADDRESS                 METHOD
# local    - Unix socket connections
# host     - TCP/IP connections (SSL optional)
# hostssl  - TCP/IP connections (SSL required)
# hostnossl- TCP/IP connections (SSL disabled) - NOT USED for security

# ==============================================================================
# LOCAL CONNECTIONS
# ==============================================================================

# Reject all local connections for remote users
local   all             remote_*                                reject

# Database superuser (emergency access only)
local   all             postgres                                peer

# Application service account (local only for migrations)
local   kgv_production  kgv_migration                          scram-sha-256

# Backup user (local only)
local   kgv_production  kgv_backup                             scram-sha-256

# ==============================================================================
# LOCALHOST CONNECTIONS (Container internal)
# ==============================================================================

# Health check user (monitoring)
hostssl kgv_production  kgv_monitor     127.0.0.1/32           scram-sha-256
hostssl kgv_production  kgv_monitor     ::1/128                scram-sha-256

# ==============================================================================
# DOCKER NETWORK CONNECTIONS
# ==============================================================================

# Application connections from Docker network (SSL required)
hostssl kgv_production  kgv_app         172.16.0.0/12          scram-sha-256
hostssl kgv_production  kgv_readonly    172.16.0.0/12          scram-sha-256

# Migration service connections
hostssl kgv_production  kgv_migration   172.16.0.0/12          scram-sha-256

# ==============================================================================
# KUBERNETES CLUSTER CONNECTIONS
# ==============================================================================

# Kubernetes pod network (adjust CIDR as needed)
hostssl kgv_production  kgv_app         10.0.0.0/8             scram-sha-256
hostssl kgv_production  kgv_readonly    10.0.0.0/8             scram-sha-256

# ==============================================================================
# AZURE PRIVATE NETWORK CONNECTIONS
# ==============================================================================

# Azure VNet connections (Germany West Central)
hostssl kgv_production  kgv_app         10.1.0.0/16            scram-sha-256
hostssl kgv_production  kgv_readonly    10.1.0.0/16            scram-sha-256
hostssl kgv_production  kgv_reporting   10.1.0.0/16            scram-sha-256

# Azure VNet connections (Germany North - DR)
hostssl kgv_production  kgv_app         10.2.0.0/16            scram-sha-256
hostssl kgv_production  kgv_readonly    10.2.0.0/16            scram-sha-256

# ==============================================================================
# REPLICATION CONNECTIONS
# ==============================================================================

# Streaming replication (SSL + certificate required)
hostssl replication     replicator      10.1.2.0/24            cert
hostssl replication     replicator      10.2.2.0/24            cert

# ==============================================================================
# ADMINISTRATIVE CONNECTIONS (Restricted)
# ==============================================================================

# DBA connections (VPN only, MFA required via external auth)
hostssl all             kgv_dba         192.168.100.0/24       scram-sha-256

# Audit user (read-only to audit schema)
hostssl kgv_production  kgv_auditor     192.168.100.0/24       scram-sha-256

# ==============================================================================
# MONITORING AND BACKUP
# ==============================================================================

# Prometheus PostgreSQL Exporter
hostssl postgres        postgres_exporter 172.16.0.0/12        scram-sha-256

# Backup service (specific times via pg_cron)
hostssl kgv_production  kgv_backup      10.1.3.10/32           scram-sha-256

# ==============================================================================
# DENY RULES (Explicit denials)
# ==============================================================================

# Deny all connections from public internet
host    all             all             0.0.0.0/0              reject
host    all             all             ::/0                   reject

# Deny non-SSL connections from any source
hostnossl all           all             0.0.0.0/0              reject
hostnossl all           all             ::/0                   reject

# ==============================================================================
# DEFAULT DENY RULE (Must be last)
# ==============================================================================

# Reject all other connections
hostssl all             all             all                    reject

# ==============================================================================
# NOTES AND BEST PRACTICES
# ==============================================================================

# 1. User Naming Convention:
#    - kgv_app: Main application user (SELECT, INSERT, UPDATE, DELETE)
#    - kgv_readonly: Read-only user for reporting
#    - kgv_migration: Migration user (temporary, higher privileges)
#    - kgv_backup: Backup user (SELECT, COPY)
#    - kgv_monitor: Monitoring user (pg_stat views only)
#    - kgv_auditor: Audit log reader
#    - kgv_dba: Database administrator

# 2. Network Segmentation:
#    - Application tier: 10.1.1.0/24
#    - Database tier: 10.1.2.0/24
#    - Management tier: 10.1.3.0/24
#    - DMZ: 10.1.4.0/24

# 3. SSL Certificate Management:
#    - Certificates expire every 365 days
#    - CA certificates in /var/lib/postgresql/ssl/ca.crt
#    - CRL updated daily via cron

# 4. Authentication Methods Priority:
#    - cert: For replication (strongest)
#    - scram-sha-256: For application users
#    - peer: For local postgres only
#    - reject: Explicit denial

# 5. Audit Requirements (GDPR):
#    - All connection attempts logged
#    - Failed authentication logged with IP
#    - Successful connections logged with timestamp
#    - Log retention: 90 days minimum

# 6. Password Policy (enforced externally):
#    - Minimum 16 characters
#    - Mixed case, numbers, special characters
#    - Rotation every 90 days
#    - No password reuse for 12 iterations

# 7. Certificate Requirements:
#    - TLS 1.3 minimum
#    - RSA 2048-bit or ECC P-256 minimum
#    - Extended Validation (EV) for production

# ==============================================================================
# EMERGENCY ACCESS PROCEDURE
# ==============================================================================

# In case of emergency, access can be granted by:
# 1. Connect locally as postgres user (requires server access)
# 2. Modify this file to add temporary access
# 3. Reload configuration: SELECT pg_reload_conf();
# 4. Document access in audit log
# 5. Remove temporary access after emergency
# 6. File incident report

# Emergency contact: security@frankfurt.de
# On-call DBA: +49-69-212-XXXXX